@page "/"
@using abp_obs_project.Permissions
@inherits abp_obs_projectComponentBase
@inject NavigationManager NavigationManager

@code {
    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        if (!CurrentUser.IsAuthenticated)
        {
            NavigationManager.NavigateTo("/authentication/login", forceLoad: true);
            return;
        }

        // Check if user is Admin (has both Students.ViewAll AND Teachers.ViewAll permissions)
        var hasStudentManagement = await AuthorizationService.IsGrantedAsync(abp_obs_projectPermissions.Students.ViewAll);
        var hasTeacherManagement = await AuthorizationService.IsGrantedAsync(abp_obs_projectPermissions.Teachers.ViewAll);

        if (hasStudentManagement && hasTeacherManagement)
        {
            // Admin
            NavigationManager.NavigateTo("/admin/dashboard", forceLoad: true);
            return;
        }

        // Check if user is Teacher (has any management-level permissions like ViewAll)
        var hasCourseManagement = await AuthorizationService.IsGrantedAsync(abp_obs_projectPermissions.Courses.ViewAll);
        var hasGradeManagement = await AuthorizationService.IsGrantedAsync(abp_obs_projectPermissions.Grades.ViewAll);
        var hasAttendanceManagement = await AuthorizationService.IsGrantedAsync(abp_obs_projectPermissions.Attendances.ViewAll);

        if (hasCourseManagement || hasGradeManagement || hasAttendanceManagement)
        {
            // Teacher
            NavigationManager.NavigateTo("/teacher/dashboard", forceLoad: true);
            return;
        }

        // Check if user is Student (has no management permissions)
        if (!hasStudentManagement && !hasTeacherManagement && !hasCourseManagement && !hasGradeManagement && !hasAttendanceManagement)
        {
            // Student
            NavigationManager.NavigateTo("/student/dashboard", forceLoad: true);
            return;
        }

        // Default fallback
        NavigationManager.NavigateTo("/authentication/login", forceLoad: true);
    }
}
