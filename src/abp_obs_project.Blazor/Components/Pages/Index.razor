@page "/"
@using abp_obs_project.Permissions
@inherits abp_obs_projectComponentBase
@inject NavigationManager NavigationManager

@code {
    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        if (!CurrentUser.IsAuthenticated)
        {
            NavigationManager.NavigateTo("/Account/Login", forceLoad: true);
            return;
        }

        // Check if user is Admin (has both Students.ViewAll AND Teachers.ViewAll permissions)
        var hasStudentManagement = await AuthorizationService.IsGrantedAsync(abp_obs_projectPermissions.Students.ViewAll);
        var hasTeacherManagement = await AuthorizationService.IsGrantedAsync(abp_obs_projectPermissions.Teachers.ViewAll);

        if (hasStudentManagement && hasTeacherManagement)
        {
            // Admin
            NavigationManager.NavigateTo("/admin/dashboard", forceLoad: true);
            return;
        }

        // Check if user is Teacher (has any management-level permissions like ViewAll)
        var hasCourseManagement = await AuthorizationService.IsGrantedAsync(abp_obs_projectPermissions.Courses.ViewAll);
        var hasGradeManagement = await AuthorizationService.IsGrantedAsync(abp_obs_projectPermissions.Grades.ViewAll);
        var hasAttendanceManagement = await AuthorizationService.IsGrantedAsync(abp_obs_projectPermissions.Attendances.ViewAll);

        if (hasCourseManagement || hasGradeManagement || hasAttendanceManagement)
        {
            // Teacher
            NavigationManager.NavigateTo("/teacher/dashboard", forceLoad: true);
            return;
        }

        // Check if user has Student role by checking if they have any student-related data access
        var hasAnyStudentPermission = await AuthorizationService.IsGrantedAsync(abp_obs_projectPermissions.Students.Default);

        if (hasAnyStudentPermission)
        {
            // Student with role assigned
            NavigationManager.NavigateTo("/student/dashboard", forceLoad: true);
            return;
        }

        // User has no roles assigned - redirect to pending approval page
        NavigationManager.NavigateTo("/pending-approval", forceLoad: true);
    }
}
