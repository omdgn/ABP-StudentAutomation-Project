@page "/teacher/my-courses"
@using abp_obs_project.Permissions
@using abp_obs_project.Courses
@using abp_obs_project.Grades
@using Volo.Abp.AspNetCore.Components.Web
@inherits abp_obs_projectComponentBase
@attribute [Authorize]

<Card>
    <CardHeader>
        <Row Class="justify-content-between">
            <Column ColumnSize="ColumnSize.IsAuto">
                <h2>
                    <i class="fas fa-book me-2"></i>@L["Menu:MyCourses"]
                </h2>
            </Column>
        </Row>
    </CardHeader>
    <CardBody>
        @if (IsTeacher)
        {
            @if (MyCourses != null && MyCourses.Any())
            {
                <DataGrid TItem="CourseDto"
                          Data="MyCourses"
                          Responsive="true"
                          ShowPager="false"
                          Striped="true"
                          Hoverable="true">
                    <DataGridColumns>
                        <DataGridColumn TItem="CourseDto"
                                        Field="@nameof(CourseDto.Code)"
                                        Caption="@L["CourseCode"]">
                        </DataGridColumn>
                        <DataGridColumn TItem="CourseDto"
                                        Field="@nameof(CourseDto.Name)"
                                        Caption="@L["CourseName"]">
                        </DataGridColumn>
                        <DataGridColumn TItem="CourseDto"
                                        Field="@nameof(CourseDto.Credits)"
                                        Caption="@L["Credits"]">
                        </DataGridColumn>
                        <DataGridColumn TItem="CourseDto"
                                        Field="@nameof(CourseDto.Status)"
                                        Caption="@L["Status"]">
                            <DisplayTemplate>
                                @L[$"Enum:CourseStatus.{context.Status}"]
                            </DisplayTemplate>
                        </DataGridColumn>
                        <DataGridColumn TItem="CourseDto"
                                        Field="@nameof(CourseDto.Id)"
                                        Caption="@L["Actions"]"
                                        Sortable="false">
                            <DisplayTemplate>
                                <Dropdown>
                                    <DropdownToggle Color="Color.Primary" Size="Size.Small">
                                        <i class="fa fa-cog"></i> @L["Actions"]
                                    </DropdownToggle>
                                    <DropdownMenu>
                                        <DropdownItem Clicked="() => OpenCourseDetailsModal(context)">
                                            <i class="fas fa-eye me-1"></i>@L["ViewDetails"]
                                        </DropdownItem>
                                        <DropdownItem Clicked="() => OpenUpdateStatusModal(context)">
                                            <i class="fas fa-edit me-1"></i>@L["UpdateStatus"]
                                        </DropdownItem>
                                        <DropdownItem Clicked="() => NavigateToGrades(context)">
                                            <i class="fas fa-star me-1"></i>@L["ManageGrades"]
                                        </DropdownItem>
                                        <DropdownItem Clicked="() => NavigateToAttendances(context)">
                                            <i class="fas fa-calendar-check me-1"></i>@L["ManageAttendances"]
                                        </DropdownItem>
                                    </DropdownMenu>
                                </Dropdown>
                            </DisplayTemplate>
                        </DataGridColumn>
                    </DataGridColumns>
                </DataGrid>
            }
            else
            {
                <Alert Color="Color.Info" Visible="true">
                    <AlertMessage>
                        <i class="fas fa-info-circle me-2"></i>@L["MyCourses:NoCourses"]
                    </AlertMessage>
                </Alert>
            }
        }
        else
        {
            <Alert Color="Color.Warning" Visible="true">
                <AlertMessage>
                    <i class="fas fa-exclamation-triangle me-2"></i>@L["Dashboard:NoAccessMessage"]
                </AlertMessage>
            </Alert>
        }
    </CardBody>
</Card>

<!-- Course Details Modal -->
<Modal @ref="CourseDetailsModal">
    <ModalContent Centered Size="ModalSize.Large">
        <ModalHeader>
            <ModalTitle>@SelectedCourse?.Name</ModalTitle>
            <CloseButton Clicked="CloseCourseDetailsModal" />
        </ModalHeader>
        <ModalBody>
            @if (SelectedCourse != null)
            {
                <Row>
                    <Column ColumnSize="ColumnSize.Is6">
                        <Field>
                            <FieldLabel>@L["CourseCode"]</FieldLabel>
                            <TextEdit Text="@SelectedCourse.Code" ReadOnly="true" />
                        </Field>
                    </Column>
                    <Column ColumnSize="ColumnSize.Is6">
                        <Field>
                            <FieldLabel>@L["Credits"]</FieldLabel>
                            <NumericEdit TValue="int" Value="@SelectedCourse.Credits" ReadOnly="true" />
                        </Field>
                    </Column>
                </Row>
                <Row>
                    <Column ColumnSize="ColumnSize.Is12">
                        <Field>
                            <FieldLabel>@L["Status"]</FieldLabel>
                            <TextEdit Text="@L[$"Enum:CourseStatus.{SelectedCourse.Status}"]" ReadOnly="true" />
                        </Field>
                    </Column>
                </Row>
                <Row>
                    <Column ColumnSize="ColumnSize.Is12">
                        <Field>
                            <FieldLabel>@L["Description"]</FieldLabel>
                            <MemoEdit Text="@SelectedCourse.Description" Rows="5" ReadOnly="true" />
                        </Field>
                    </Column>
                </Row>

                <Divider />

                <Row>
                    <Column ColumnSize="ColumnSize.Is12">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5 class="mb-0">
                                <i class="fas fa-user-graduate me-2"></i>@L["Menu:MyStudents"]
                            </h5>
                            <Button Color="Color.Primary" Size="Size.Small" Clicked="OpenAddStudentModal">
                                <i class="fas fa-user-plus me-1"></i>@L["NewStudent"]
                            </Button>
                        </div>

                        @if (SelectedCourseGrades != null && SelectedCourseGrades.Any())
                        {
                            <DataGrid TItem="GradeDto"
                                      Data="SelectedCourseGrades"
                                      Responsive="true"
                                      ShowPager="false"
                                      Striped="true"
                                      Hoverable="true">
                                <DataGridColumns>
                                    <DataGridColumn TItem="GradeDto" Field="@nameof(GradeDto.StudentName)" Caption="@L["Students"]" />
                                    <DataGridColumn TItem="GradeDto" Field="@nameof(GradeDto.GradeValue)" Caption="@L["Grades"]" />
                                </DataGridColumns>
                            </DataGrid>
                        }
                        else
                        {
                            <Alert Color="Color.Light" Visible="true">
                                <AlertMessage>
                                    <i class="fas fa-info-circle me-2"></i>@L["MyCourses:NoCourses"]
                                </AlertMessage>
                            </Alert>
                        }
                    </Column>
                </Row>
            }
        </ModalBody>
        <ModalFooter>
            <Button Color="Color.Secondary" Clicked="CloseCourseDetailsModal">@L["Close"]</Button>
        </ModalFooter>
    </ModalContent>
</Modal>

<!-- Update Status Modal -->
<Modal @ref="UpdateStatusModal">
    <ModalContent Centered>
        <ModalHeader>
            <ModalTitle>@L["UpdateCourseStatus"]</ModalTitle>
            <CloseButton Clicked="CloseUpdateStatusModal" />
        </ModalHeader>
        <ModalBody>
            @if (EditingCourse != null)
            {
                <Field>
                    <FieldLabel>@L["Course"]</FieldLabel>
                    <TextEdit Text="@EditingCourse.Name" ReadOnly="true" />
                </Field>
                <Field>
                    <FieldLabel>@L["Status"] *</FieldLabel>
                    <Select TValue="EnumCourseStatus" @bind-SelectedValue="@NewStatus">
                        @foreach (var status in Enum.GetValues<EnumCourseStatus>())
                        {
                            <SelectItem Value="@status">@L[$"Enum:CourseStatus.{status}"]</SelectItem>
                        }
                    </Select>
                </Field>
            }
        </ModalBody>
        <ModalFooter>
            <Button Color="Color.Secondary" Clicked="CloseUpdateStatusModal">@L["Cancel"]</Button>
            <Button Color="Color.Primary" Clicked="UpdateCourseStatusAsync">@L["Save"]</Button>
        </ModalFooter>
    </ModalContent>
</Modal>

<!-- Add Student Modal -->
<Modal @ref="AddStudentModal">
    <ModalContent Centered>
        <ModalHeader>
            <ModalTitle>@L["NewStudent"]</ModalTitle>
            <CloseButton Clicked="CloseAddStudentModal" />
        </ModalHeader>
        <ModalBody>
            @if (AvailableStudentsToAdd.Any())
            {
                <Field>
                    <FieldLabel>@L["Students"] *</FieldLabel>
                    <Select TValue="Guid?" @bind-SelectedValue="SelectedStudentToAdd">
                        @foreach (var s in AvailableStudentsToAdd)
                        {
                            <SelectItem Value="@s.Id">@s.DisplayName</SelectItem>
                        }
                    </Select>
                </Field>
                <small class="text-muted">@L["Permission:Courses.ManageStudents"]</small>
            }
            else
            {
                <Alert Color="Color.Info" Visible="true">
                    <AlertMessage>
                        <i class="fas fa-info-circle me-2"></i>@L["MyCourses:NoCourses"]
                    </AlertMessage>
                </Alert>
            }
        </ModalBody>
        <ModalFooter>
            <Button Color="Color.Secondary" Clicked="CloseAddStudentModal">@L["Cancel"]</Button>
            <Button Color="Color.Primary" Disabled="@(!AvailableStudentsToAdd.Any() || SelectedStudentToAdd == null)" Clicked="AddStudentToCourseAsync">@L["Save"]</Button>
        </ModalFooter>
    </ModalContent>
    
</Modal>
